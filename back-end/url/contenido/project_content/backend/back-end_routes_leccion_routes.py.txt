# ARCHIVO: back-end/routes/leccion_routes.py
# URL: https://raw.githubusercontent.com/sTr4yDev/speakLexi/main/back-end/routes/leccion_routes.py
# FECHA DESCARGA: 2025-10-29 18:39:56
# ==================================================

"""
Rutas API para gestión de lecciones y actividades - SpeakLexi
Endpoints REST para el módulo de lecciones
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from services.gestor_lecciones import gestor_lecciones
from models.usuario import Usuario
from models.cursos import Curso
from functools import wraps

# Crear blueprint
leccion_bp = Blueprint('lecciones', __name__, url_prefix='/api/lecciones')


# ========== DECORADORES ==========

def validar_permisos_admin_profesor(f):
    """Decorador para validar permisos de admin o profesor"""
    @wraps(f)
    def decorated(*args, **kwargs):
        usuario_id = get_jwt_identity()
        usuario = Usuario.query.get(usuario_id)
        
        if not usuario or usuario.rol not in ['admin', 'profesor']:
            return jsonify({
                'success': False,
                'error': 'No autorizado. Se requiere rol de administrador o profesor.'
            }), 403
        
        return f(*args, **kwargs)
    return decorated


def validar_profesor_curso(f):
    """Decorador para validar que el profesor sea dueño del curso"""
    @wraps(f)
    def decorated(*args, **kwargs):
        usuario_id = get_jwt_identity()
        usuario = Usuario.query.get(usuario_id)
        
        # Admin puede todo
        if usuario.rol == 'admin':
            return f(*args, **kwargs)
        
        # Profesor debe ser dueño del curso
        if usuario.rol == 'profesor':
            # Obtener curso_id del body o de la lección
            data = request.get_json()
            curso_id = data.get('curso_id') if data else None
            
            # Si no hay curso_id en el body, obtenerlo de la lección
            if not curso_id and 'leccion_id' in kwargs:
                from models.leccion import Leccion
                leccion = Leccion.query.get(kwargs['leccion_id'])
                if leccion:
                    curso_id = leccion.curso_id
            
            if curso_id:
                curso = Curso.query.get(curso_id)
                if curso and curso.profesor_id != usuario_id:
                    return jsonify({
                        'success': False,
                        'error': 'No puedes gestionar lecciones de cursos que no son tuyos'
                    }), 403
        
        return f(*args, **kwargs)
    return decorated


# ========== ENDPOINTS DE LECCIONES ==========

@leccion_bp.route('', methods=['GET'])
def listar_lecciones():
    """
    GET /api/lecciones
    Lista todas las lecciones con filtros opcionales
    
    Query params:
        - curso_id: filtrar por curso
        - nivel: principiante|intermedio|avanzado
        - idioma: ingles|espanol|etc
        - categoria: vocabulario|gramatica|etc
        - estado: borrador|publicada|archivada
        - buscar: término de búsqueda
        - etiqueta: etiqueta específica
        - pagina: número de página (default: 1)
        - por_pagina: items por página (default: 20)
    """
    try:
        # Obtener parámetros de consulta
        filtros = {
            'curso_id': request.args.get('curso_id', type=int),
            'nivel': request.args.get('nivel'),
            'idioma': request.args.get('idioma'),
            'categoria': request.args.get('categoria'),
            'estado': request.args.get('estado'),
            'buscar': request.args.get('buscar'),
            'etiqueta': request.args.get('etiqueta')
        }
        
        # Remover valores None
        filtros = {k: v for k, v in filtros.items() if v is not None}
        
        pagina = request.args.get('pagina', 1, type=int)
        por_pagina = request.args.get('por_pagina', 20, type=int)
        
        resultado, codigo = gestor_lecciones.listar_lecciones(
            filtros=filtros,
            pagina=pagina,
            por_pagina=por_pagina
        )
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al listar lecciones: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>', methods=['GET'])
def obtener_leccion(leccion_id):
    """
    GET /api/lecciones/<id>
    Obtiene una lección específica
    
    Query params:
        - incluir_actividades: true|false (default: false)
        - incluir_multimedia: true|false (default: false)
    """
    try:
        incluir_actividades = request.args.get('incluir_actividades', 'false').lower() == 'true'
        incluir_multimedia = request.args.get('incluir_multimedia', 'false').lower() == 'true'
        
        resultado, codigo = gestor_lecciones.obtener_leccion(
            leccion_id,
            incluir_actividades=incluir_actividades,
            incluir_multimedia=incluir_multimedia
        )
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al obtener lección: {str(e)}"
        }), 500


@leccion_bp.route('', methods=['POST'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def crear_leccion():
    """
    POST /api/lecciones
    Crea una nueva lección
    
    Body JSON:
    {
        "curso_id": int (requerido),
        "titulo": "string (requerido)",
        "descripcion": "string",
        "contenido": {}, // JSON con contenido estructurado
        "nivel": "principiante|intermedio|avanzado",
        "idioma": "string",
        "categoria": "string",
        "etiquetas": ["tag1", "tag2"],
        "orden": int,
        "requisitos": [id1, id2], // IDs de lecciones previas
        "duracion_estimada": int, // minutos
        "puntos_xp": int
    }
    """
    try:
        usuario_id = get_jwt_identity()
        datos = request.get_json()
        
        if not datos:
            return jsonify({
                'success': False,
                'error': "No se proporcionaron datos"
            }), 400
        
        # Validar curso_id
        if not datos.get('curso_id'):
            return jsonify({
                'success': False,
                'error': 'El curso_id es obligatorio'
            }), 400
        
        resultado, codigo = gestor_lecciones.crear_leccion(datos, usuario_id)
        
        if codigo == 201:
            return jsonify({
                'success': True,
                **resultado
            }), codigo
        else:
            return jsonify({
                'success': False,
                **resultado
            }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al crear lección: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>', methods=['PUT', 'PATCH'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def actualizar_leccion(leccion_id):
    """
    PUT/PATCH /api/lecciones/<id>
    Actualiza una lección existente
    
    Body JSON: Campos a actualizar (mismos que POST)
    """
    try:
        usuario_id = get_jwt_identity()
        datos = request.get_json()
        
        if not datos:
            return jsonify({
                'success': False,
                'error': "No se proporcionaron datos"
            }), 400
        
        resultado, codigo = gestor_lecciones.actualizar_leccion(
            leccion_id,
            datos,
            usuario_id
        )
        
        if codigo == 200:
            return jsonify({
                'success': True,
                **resultado
            }), codigo
        else:
            return jsonify({
                'success': False,
                **resultado
            }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al actualizar lección: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>', methods=['DELETE'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def eliminar_leccion(leccion_id):
    """
    DELETE /api/lecciones/<id>
    Elimina (archiva) una lección
    """
    try:
        usuario_id = get_jwt_identity()
        resultado, codigo = gestor_lecciones.eliminar_leccion(leccion_id, usuario_id)
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al eliminar lección: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>/publicar', methods=['POST'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def publicar_leccion(leccion_id):
    """
    POST /api/lecciones/<id>/publicar
    Publica una lección (cambia estado de borrador a publicada)
    """
    try:
        usuario_id = get_jwt_identity()
        resultado, codigo = gestor_lecciones.publicar_leccion(leccion_id, usuario_id)
        
        if codigo == 200:
            return jsonify({
                'success': True,
                **resultado
            }), codigo
        else:
            return jsonify({
                'success': False,
                **resultado
            }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al publicar lección: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>/estadisticas', methods=['GET'])
@jwt_required()
def obtener_estadisticas_leccion(leccion_id):
    """
    GET /api/lecciones/<id>/estadisticas
    Obtiene estadísticas de una lección
    """
    try:
        resultado, codigo = gestor_lecciones.obtener_estadisticas_leccion(leccion_id)
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al obtener estadísticas: {str(e)}"
        }), 500


@leccion_bp.route('/nivel/<string:nivel>', methods=['GET'])
def obtener_lecciones_por_nivel(nivel):
    """
    GET /api/lecciones/nivel/<nivel>
    Obtiene lecciones por nivel de dificultad
    
    Query params:
        - idioma: filtro opcional por idioma
    """
    try:
        idioma = request.args.get('idioma')
        resultado, codigo = gestor_lecciones.obtener_lecciones_por_nivel(nivel, idioma)
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al obtener lecciones: {str(e)}"
        }), 500


@leccion_bp.route('/curso/<int:curso_id>', methods=['GET'])
def obtener_lecciones_por_curso(curso_id):
    """
    GET /api/lecciones/curso/<curso_id>
    Obtiene todas las lecciones de un curso
    
    Query params:
        - solo_publicadas: true|false (default: true)
    """
    try:
        solo_publicadas = request.args.get('solo_publicadas', 'true').lower() == 'true'
        resultado, codigo = gestor_lecciones.obtener_lecciones_por_curso(curso_id, solo_publicadas)
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al obtener lecciones del curso: {str(e)}"
        }), 500


# ========== ENDPOINTS DE ACTIVIDADES ==========

@leccion_bp.route('/<int:leccion_id>/actividades', methods=['POST'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def agregar_actividad(leccion_id):
    """
    POST /api/lecciones/<id>/actividades
    Agrega una actividad a una lección
    
    Body JSON:
    {
        "tipo": "multiple_choice|fill_blank|matching|translation|true_false|word_order",
        "pregunta": "string (requerido)",
        "instrucciones": "string",
        "opciones": {}, // Estructura varía según tipo
        "respuesta_correcta": {}, // Estructura varía según tipo
        "retroalimentacion": {
            "correcta": "mensaje",
            "incorrecta": "mensaje"
        },
        "pista": "string",
        "puntos": int,
        "orden": int,
        "tiempo_limite": int, // segundos
        "multimedia_id": int
    }
    """
    try:
        datos = request.get_json()
        
        if not datos:
            return jsonify({
                'success': False,
                'error': "No se proporcionaron datos"
            }), 400
        
        resultado, codigo = gestor_lecciones.agregar_actividad(leccion_id, datos)
        
        if codigo == 201:
            return jsonify({
                'success': True,
                **resultado
            }), codigo
        else:
            return jsonify({
                'success': False,
                **resultado
            }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al agregar actividad: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>/actividades/<int:actividad_id>', methods=['PUT', 'PATCH'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def actualizar_actividad(leccion_id, actividad_id):
    """
    PUT/PATCH /api/lecciones/<leccion_id>/actividades/<actividad_id>
    Actualiza una actividad
    
    Body JSON: Campos a actualizar (mismos que POST)
    """
    try:
        datos = request.get_json()
        
        if not datos:
            return jsonify({
                'success': False,
                'error': "No se proporcionaron datos"
            }), 400
        
        resultado, codigo = gestor_lecciones.actualizar_actividad(actividad_id, datos)
        
        if codigo == 200:
            return jsonify({
                'success': True,
                **resultado
            }), codigo
        else:
            return jsonify({
                'success': False,
                **resultado
            }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al actualizar actividad: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>/actividades/<int:actividad_id>', methods=['DELETE'])
@jwt_required()
@validar_permisos_admin_profesor
@validar_profesor_curso
def eliminar_actividad(leccion_id, actividad_id):
    """
    DELETE /api/lecciones/<leccion_id>/actividades/<actividad_id>
    Elimina una actividad
    """
    try:
        resultado, codigo = gestor_lecciones.eliminar_actividad(actividad_id)
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al eliminar actividad: {str(e)}"
        }), 500


@leccion_bp.route('/<int:leccion_id>/actividades/<int:actividad_id>/verificar', methods=['POST'])
@jwt_required()
def verificar_respuesta(leccion_id, actividad_id):
    """
    POST /api/lecciones/<leccion_id>/actividades/<actividad_id>/verificar
    Verifica la respuesta de un usuario a una actividad
    
    Body JSON:
    {
        "respuesta": <any> // Formato depende del tipo de actividad
    }
    """
    try:
        datos = request.get_json()
        
        if not datos or 'respuesta' not in datos:
            return jsonify({
                'success': False,
                'error': "Debe proporcionar una respuesta"
            }), 400
        
        resultado, codigo = gestor_lecciones.verificar_respuesta_actividad(
            actividad_id,
            datos['respuesta']
        )
        
        return jsonify({
            'success': True,
            **resultado
        }), codigo
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f"Error al verificar respuesta: {str(e)}"
        }), 500


# ========== MANEJO DE ERRORES ==========

@leccion_bp.errorhandler(404)
def not_found(error):
    return jsonify({
        'success': False,
        'error': "Recurso no encontrado"
    }), 404


@leccion_bp.errorhandler(500)
def internal_error(error):
    return jsonify({
        'success': False,
        'error': "Error interno del servidor"
    }), 500


# ========== INFORMACIÓN DEL BLUEPRINT ==========

@leccion_bp.route('/info', methods=['GET'])
def info():
    """Información sobre los endpoints disponibles"""
    return jsonify({
        "nombre": "API de Lecciones - SpeakLexi",
        "version": "2.0.0",
        "endpoints": {
            "lecciones": {
                "GET /api/lecciones": "Listar lecciones con filtros (incluye curso_id)",
                "GET /api/lecciones/<id>": "Obtener lección específica",
                "POST /api/lecciones": "Crear nueva lección (requiere curso_id)",
                "PUT /api/lecciones/<id>": "Actualizar lección",
                "DELETE /api/lecciones/<id>": "Eliminar lección",
                "POST /api/lecciones/<id>/publicar": "Publicar lección",
                "GET /api/lecciones/<id>/estadisticas": "Estadísticas de lección",
                "GET /api/lecciones/nivel/<nivel>": "Lecciones por nivel",
                "GET /api/lecciones/curso/<curso_id>": "Lecciones por curso"
            },
            "actividades": {
                "POST /api/lecciones/<id>/actividades": "Agregar actividad",
                "PUT /api/lecciones/<id>/actividades/<aid>": "Actualizar actividad",
                "DELETE /api/lecciones/<id>/actividades/<aid>": "Eliminar actividad",
                "POST /api/lecciones/<id>/actividades/<aid>/verificar": "Verificar respuesta"
            }
        },
        "autenticacion": "Requiere JWT token en header: Authorization: Bearer <token>",
        "roles": {
            "admin": "Acceso completo a todas las operaciones",
            "profesor": "Solo puede gestionar lecciones de sus propios cursos",
            "alumno": "Solo puede ver lecciones publicadas y verificar respuestas"
        }
    }), 200